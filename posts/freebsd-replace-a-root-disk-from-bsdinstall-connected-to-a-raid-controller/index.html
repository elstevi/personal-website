<!DOCTYPE html>
<html prefix="" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>FreeBSD replace a root disk from bsdinstall connected to a RAID controller | dereference</title>
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/dark.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Share+Tech+Mono" rel="stylesheet">
<link href="../../assets/css/custom.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://stevendouglas.me/posts/freebsd-replace-a-root-disk-from-bsdinstall-connected-to-a-raid-controller/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Steven Douglas">
<link rel="next" href="../backup-wordpress-website-offsite-with-tarsnap/" title="Backup Wordpress website offsite with Tarsnap" type="text/html">
<meta property="og:site_name" content="dereference">
<meta property="og:title" content="FreeBSD replace a root disk from bsdinstall connected to a RAID contro">
<meta property="og:url" content="https://stevendouglas.me/posts/freebsd-replace-a-root-disk-from-bsdinstall-connected-to-a-raid-controller/">
<meta property="og:description" content="I have a failed drive in my pool!
# mfiutil show drives
mfi0 Physical Drives:
 0 (  137G) FAILED &lt;FUJITSU MBE2147RC D905 serial=D304PB40ASPD&gt; SAS E1:S0
 1 (  932G) ONLINE &lt;MM1000GBKAL HPGB serial=9XG2">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-03-27T22:51:26-07:00">
</head>
<body class="hack dark">

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
         
    <header id="header"><h1 id="brand"><a href="../../" title="dereference" rel="home">

        <span id="blog-title">dereference</span>
    </a></h1>

        

        
    <nav id="menu"><ul>
<li><a href="../../archive.html">Posts by date</a></li>
                <li><a href="../../resume-latest-public.pdf">Resume</a></li>
                <li><a href="../../rss.xml">RSS feed</a></li>
                <li><a href="../../categories/">Tags</a></li>
                <li><a href="https://github.com/elstevi/"><img class="socialmedia" width="25px" src="../../github.png"></a></li>
                <li><a href="https://www.linkedin.com/in/steven-douglas-b301a4137"><img class="socialmedia" width="30px" src="../../linkedin.png"></a></li>
                <li><a href="https://twitter.com/elstevi"><img class="socialmedia" width="25px" src="../../twitter.png"></a></li>

    

    
    
    </ul></nav></header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">FreeBSD replace a root disk from bsdinstall connected to a RAID controller</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Steven Douglas
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2018-03-27T22:51:26-07:00" itemprop="datePublished" title="2018-03-27 22:51">2018-03-27 22:51</time></a>
            </p>
            
        <p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>I have a failed drive in my pool!</p>
<div class="code"><pre class="code literal-block">#<span class="w"> </span><span class="nv">mfiutil</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="nv">drives</span>
<span class="nv">mfi0</span><span class="w"> </span><span class="nv">Physical</span><span class="w"> </span><span class="nv">Drives</span>:
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">(</span><span class="w">  </span><span class="mi">137</span><span class="nv">G</span><span class="ss">)</span><span class="w"> </span><span class="nv">FAILED</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">FUJITSU</span><span class="w"> </span><span class="nv">MBE2147RC</span><span class="w"> </span><span class="nv">D905</span><span class="w"> </span><span class="nv">serial</span><span class="o">=</span><span class="nv">D304PB40ASPD</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">SAS</span><span class="w"> </span><span class="nv">E1</span>:<span class="nv">S0</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">(</span><span class="w">  </span><span class="mi">932</span><span class="nv">G</span><span class="ss">)</span><span class="w"> </span><span class="nv">ONLINE</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">MM1000GBKAL</span><span class="w"> </span><span class="nv">HPGB</span><span class="w"> </span><span class="nv">serial</span><span class="o">=</span><span class="mi">9</span><span class="nv">XG259SP</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">SATA</span><span class="w"> </span><span class="nv">E1</span>:<span class="nv">S1</span>
</pre></div>

<!-- TEASER_END -->

<p>I just replaced the old bad drive with a shiny new (larger) one:</p>
<div class="code"><pre class="code literal-block">#<span class="w"> </span><span class="nv">mfiutil</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="nv">drives</span>
<span class="nv">mfi0</span><span class="w"> </span><span class="nv">Physical</span><span class="w"> </span><span class="nv">Drives</span>:
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">(</span><span class="w">  </span><span class="mi">932</span><span class="nv">G</span><span class="ss">)</span><span class="w"> </span><span class="nv">UNCONFIGURED</span><span class="w"> </span><span class="nv">GOOD</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">MM1000GBKAL</span><span class="w"> </span><span class="nv">HPGC</span><span class="w"> </span><span class="nv">serial</span><span class="o">=</span><span class="mi">9</span><span class="nv">XG271GS</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">SATA</span><span class="w"> </span><span class="nv">E1</span>:<span class="nv">S0</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">(</span><span class="w">  </span><span class="mi">932</span><span class="nv">G</span><span class="ss">)</span><span class="w"> </span><span class="nv">ONLINE</span><span class="w">            </span><span class="o">&lt;</span><span class="nv">MM1000GBKAL</span><span class="w"> </span><span class="nv">HPGB</span><span class="w"> </span><span class="nv">serial</span><span class="o">=</span><span class="mi">9</span><span class="nv">XG259SP</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">SATA</span><span class="w"> </span><span class="nv">E1</span>:<span class="nv">S1</span>
</pre></div>

<p>And finally create a new raid0 to pass this disk through:</p>
<div class="code"><pre class="code literal-block"># mfiutil create raid0 1
mfiutil: Command failed: Status: 0x54
mfiutil: Failed to add volume: Input/output error
</pre></div>

<p>Uh oh. After installing <code>sysutils/megacli</code> from ports, eventually I figured out that this was an issue with data in the controller cache:</p>
<div class="code"><pre class="code literal-block">#<span class="w"> </span><span class="nv">MegaCli</span><span class="w"> </span><span class="o">-</span><span class="nv">CfgLdAdd</span><span class="w"> </span><span class="o">-</span><span class="nv">r0</span><span class="w"> </span>[<span class="mi">32</span>:<span class="mi">1</span>]<span class="w"> </span><span class="o">-</span><span class="nv">a0</span>


<span class="nv">Adapter</span><span class="w"> </span><span class="mi">0</span>:<span class="w"> </span><span class="nv">Configure</span><span class="w"> </span><span class="nv">Adapter</span><span class="w"> </span><span class="nv">Failed</span>

<span class="nv">FW</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">description</span>:
<span class="w">  </span><span class="nv">The</span><span class="w"> </span><span class="nv">current</span><span class="w"> </span><span class="nv">operation</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">allowed</span><span class="w"> </span><span class="nv">because</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">controller</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">cache</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">offline</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">missing</span><span class="w"> </span><span class="nv">virtual</span><span class="w"> </span><span class="nv">drives</span>.

<span class="k">Exit</span><span class="w"> </span><span class="nv">Code</span>:<span class="w"> </span><span class="mi">0</span><span class="nv">x54</span>
</pre></div>

<p>32 is my adapter ID. I found that in the LSI Controller list. Now we can discard that cache data:</p>
<div class="code"><pre class="code literal-block">#<span class="w"> </span><span class="nv">MegaCli</span><span class="w"> </span><span class="o">-</span><span class="nv">DiscardPreservedCache</span><span class="w"> </span><span class="o">-</span><span class="nv">L0</span><span class="w"> </span><span class="o">-</span><span class="nv">a0</span>
<span class="nv">Adapter</span><span class="w"> </span><span class="sc">#0</span>
<span class="nv">Virtual</span><span class="w"> </span><span class="nv">Drive</span><span class="ss">(</span><span class="nv">Target</span><span class="w"> </span><span class="nv">ID</span><span class="w"> </span><span class="mi">00</span><span class="ss">)</span>:<span class="w"> </span><span class="nv">Preserved</span><span class="w"> </span><span class="nv">Cache</span><span class="w"> </span><span class="nv">Data</span><span class="w"> </span><span class="nv">Cleared</span>.
<span class="k">Exit</span><span class="w"> </span><span class="nv">Code</span>:<span class="w"> </span><span class="mi">0</span><span class="nv">x00</span>
</pre></div>

<p>Now:</p>
<div class="code"><pre class="code literal-block"># mfiutil create raid0 1
</pre></div>

<p>Returns normally.</p>
<p>Now you can partition the GPT disk (I am ommitting the swap partition):</p>
<div class="code"><pre class="code literal-block"># gpart create -s gpt /dev/mfid0
# gpart add -t freebsd-boot -s 512K mfid0
# gpart add -t freebsd-zfs -A 1M mfid0
# gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 mfid0
</pre></div>

<p>And replace the disk:</p>
<div class="code"><pre class="code literal-block"><span class="err">#</span><span class="w"> </span><span class="n">zpool</span><span class="w"> </span><span class="nf">replace</span><span class="w"> </span><span class="n">zroot</span><span class="w"> </span><span class="mi">5429029324314476965</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mfid0p2</span>
<span class="err">#</span><span class="w"> </span><span class="n">zpool</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="n">zroot</span>
<span class="w">  </span><span class="nl">pool</span><span class="p">:</span><span class="w"> </span><span class="n">zroot</span>
<span class="w"> </span><span class="k">state</span><span class="err">:</span><span class="w"> </span><span class="n">DEGRADED</span>
<span class="nl">status</span><span class="p">:</span><span class="w"> </span><span class="n">One</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="n">resilvered</span><span class="p">.</span><span class="w">  </span><span class="n">The</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="n">will</span>
<span class="w">        </span><span class="k">continue</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">function</span><span class="p">,</span><span class="w"> </span><span class="n">possibly</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">degraded</span><span class="w"> </span><span class="k">state</span><span class="p">.</span>
<span class="k">action</span><span class="err">:</span><span class="w"> </span><span class="n">Wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">resilver</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">complete</span><span class="p">.</span>
<span class="w">  </span><span class="nl">scan</span><span class="p">:</span><span class="w"> </span><span class="n">resilver</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">progress</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">Thu</span><span class="w"> </span><span class="n">Nov</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">23</span><span class="err">:</span><span class="mi">43</span><span class="err">:</span><span class="mi">26</span><span class="w"> </span><span class="mi">2017</span>
<span class="w">        </span><span class="mi">999</span><span class="n">M</span><span class="w"> </span><span class="n">scanned</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="mf">55.5</span><span class="n">G</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mf">22.2</span><span class="n">M</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">h41m</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">go</span>
<span class="w">        </span><span class="mi">999</span><span class="n">M</span><span class="w"> </span><span class="n">resilvered</span><span class="p">,</span><span class="w"> </span><span class="mf">1.76</span><span class="o">%</span><span class="w"> </span><span class="n">done</span>
<span class="nl">config</span><span class="p">:</span>

<span class="w">        </span><span class="n">NAME</span><span class="w">                       </span><span class="k">STATE</span><span class="w">     </span><span class="k">READ</span><span class="w"> </span><span class="k">WRITE</span><span class="w"> </span><span class="n">CKSUM</span>
<span class="w">        </span><span class="n">zroot</span><span class="w">                      </span><span class="n">DEGRADED</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span>
<span class="w">          </span><span class="n">mirror</span><span class="o">-</span><span class="mi">0</span><span class="w">                 </span><span class="n">DEGRADED</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span>
<span class="w">            </span><span class="n">replacing</span><span class="o">-</span><span class="mi">0</span><span class="w">            </span><span class="n">UNAVAIL</span><span class="w">      </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span>
<span class="w">              </span><span class="mi">3351751284279945146</span><span class="w">  </span><span class="n">UNAVAIL</span><span class="w">      </span><span class="mi">0</span><span class="w">   </span><span class="mi">296</span><span class="w">     </span><span class="mi">0</span><span class="w">  </span><span class="n">was</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mfid0p3</span>
<span class="w">              </span><span class="n">mfid0p2</span><span class="w">              </span><span class="n">ONLINE</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">  </span><span class="p">(</span><span class="n">resilvering</span><span class="p">)</span>
<span class="w">            </span><span class="n">mfid1p2</span><span class="w">                </span><span class="n">ONLINE</span><span class="w">       </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span>
</pre></div>

<p>Eventually, when the resilver finishes, you will be left with this:</p>
<div class="code"><pre class="code literal-block"># zpool status zroot
  pool: zroot
 state: ONLINE
  scan: resilvered 55.5G in 0h28m with 0 errors on Fri Nov 24 00:11:52 2017
config:

        NAME         STATE     READ WRITE CKSUM
        zroot        ONLINE       0     0     0
          mirror-0   ONLINE       0     0     0
            mfid0p2  ONLINE       0     0     0
            mfid1p2  ONLINE       0     0     0

errors: No known data errors
</pre></div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="next">
                <a href="../backup-wordpress-website-offsite-with-tarsnap/" rel="next" title="Backup Wordpress website offsite with Tarsnap">Next post</a>
            </li>
        </ul></nav></aside></article></main><footer id="footer"><p>©2025 Steven Douglas</p>
            
        </footer>
</div>
    
    

    
    
    
</body>
</html>
