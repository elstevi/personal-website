<!DOCTYPE html>
<html prefix="" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>iocage/iocell jail nat networking | dereference</title>
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/dark.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Share+Tech+Mono" rel="stylesheet">
<link href="../../assets/css/custom.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://stevendouglas.me/posts/iocageiocell-jail-nat-networking/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Steven Douglas">
<link rel="prev" href="../linux-phonehome/" title="linux phonehome" type="text/html">
<link rel="next" href="../connecting-to-a-drac-5-from-modern-linux/" title="Connecting to a drac 5 from modern linux" type="text/html">
<meta property="og:site_name" content="dereference">
<meta property="og:title" content="iocage/iocell jail nat networking">
<meta property="og:url" content="https://stevendouglas.me/posts/iocageiocell-jail-nat-networking/">
<meta property="og:description" content="Giving jails their own subnet and routing traffic into that subnet with PF has some benefits. It allows jails to communicate freely between themselves, but keep that traffic on the backend private sub">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-03-27T23:06:31-07:00">
<meta property="article:tag" content="bridge">
<meta property="article:tag" content="freebsd">
<meta property="article:tag" content="jails">
<meta property="article:tag" content="pf">
</head>
<body class="hack dark">

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
         
    <header id="header"><h1 id="brand"><a href="../../" title="dereference" rel="home">

        <span id="blog-title">dereference</span>
    </a></h1>

        

        
    <nav id="menu"><ul>
<li><a href="../../archive.html">Posts by date</a></li>
                <li><a href="../../resume-latest-public.pdf">Resume</a></li>
                <li><a href="../../rss.xml">RSS feed</a></li>
                <li><a href="../../categories/">Tags</a></li>
                <li><a href="https://github.com/elstevi/"><img class="socialmedia" width="25px" src="../../github.png"></a></li>
                <li><a href="https://www.linkedin.com/in/steven-douglas-b301a4137"><img class="socialmedia" width="30px" src="../../linkedin.png"></a></li>
                <li><a href="https://twitter.com/elstevi"><img class="socialmedia" width="25px" src="../../twitter.png"></a></li>

    

    
    
    </ul></nav></header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">iocage/iocell jail nat networking</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Steven Douglas
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2018-03-27T23:06:31-07:00" itemprop="datePublished" title="2018-03-27 23:06">2018-03-27 23:06</time></a>
            </p>
            
        <p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Giving jails their own subnet and routing traffic into that subnet with PF has some benefits. It allows jails to communicate freely between themselves, but keep that traffic on the backend private subnet. I like exposing an ssh service running in a jail on the backend, and using -D flag of ssh to proxy some ssh and http traffic to the backend network. Kind of a poor mans development environment and VPN.</p>
<!-- TEASER_END -->
<h3>Create backend subnet</h3>

<p>The subnet I will be using in this example is 172.16.17.0/24. The jail host will be using the gateway IP 172.16.17.1. I'll create the bridge for the next reboot:</p>
<div class="code"><pre class="code literal-block">sysrc cloned_interfaces+="bridge0"
sysrc ifconfig_bridge0="172.16.17.1/24"
</pre></div>

<p>And create it on the live system:</p>
<div class="code"><pre class="code literal-block">ifconfig bridge0 create
ifconfig bridge0 172.16.17.1/24 up
</pre></div>

<h3>Configure traffic routing into and out of the backend subnet</h3>

<p>Configure pf like this: (/etc/pf.conf)</p>
<div class="code"><pre class="code literal-block"><span class="cp"># External interface, the wan side of the nat</span>
<span class="n">ext_if</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"cxgb0"</span>

<span class="cp"># Internal interface</span>
<span class="n">int_if</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"bridge0"</span>
<span class="n">localnet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">int_if</span><span class="o">:</span><span class="n">network</span>

<span class="n">ports_to_forward</span><span class="o">=</span><span class="s">"{ 80, 443 }"</span>
<span class="n">forward_host</span><span class="o">=</span><span class="s">"172.16.17.10"</span>

<span class="n">nat</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="err">$</span><span class="n">ext_if</span><span class="w"> </span><span class="n">inet</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="err">$</span><span class="n">localnet</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kr">any</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">ext_if</span><span class="p">)</span>
<span class="n">rdr</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="err">$</span><span class="n">ext_if</span><span class="w"> </span><span class="n">proto</span><span class="w"> </span><span class="n">tcp</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="kr">any</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kr">any</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="err">$</span><span class="n">ports_to_forward</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="err">$</span><span class="n">forward_host</span>

<span class="n">pass</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">self</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">localnet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kr">any</span><span class="w"> </span><span class="kr">keep</span><span class="w"> </span><span class="n">state</span>
<span class="n">pass</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="err">$</span><span class="n">ext_if</span><span class="w"> </span><span class="n">proto</span><span class="w"> </span><span class="p">{</span><span class="n">udp</span><span class="p">,</span><span class="w"> </span><span class="n">tcp</span><span class="p">}</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="kr">any</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kr">any</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="err">$</span><span class="n">ports_to_forward</span><span class="w"> </span><span class="kr">keep</span><span class="w"> </span><span class="n">state</span>

<span class="nf">set</span><span class="w"> </span><span class="kr">skip</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">bridge0</span>
</pre></div>

<p>Enable PF on next boot and on the live system:</p>
<div class="code"><pre class="code literal-block">sysrc pf_enable="YES"
service pf start
</pre></div>

<p>Also, enable gateway on boot and on the live system:</p>
<div class="code"><pre class="code literal-block">sysrc gateway_enable="YES"
service gateway start
</pre></div>

<p>This enables the FreeBSD machine to forward ipv4 packets between subnets it sees.</p>
<h3>Create jail and configure it to have an IP on the bridge</h3>
<p>This will create a jail on the subnet with access</p>
<div class="code"><pre class="code literal-block"><span class="nx">iocell</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">tag</span><span class="p">=</span><span class="nx">testjail</span><span class="w"> </span><span class="nx">ip4_addr</span><span class="p">=</span><span class="s">"bridge0|172.16.17.10"</span><span class="w"> </span><span class="nx">defaultrouter</span><span class="p">=</span><span class="s">"172.16.17.1"</span><span class="w"> </span><span class="nx">boot</span><span class="p">=</span><span class="nx">on</span>
<span class="nx">iocell</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nx">testjail</span>
<span class="nx">iocell</span><span class="w"> </span><span class="nx">console</span><span class="w"> </span><span class="nx">testjail</span>
</pre></div>

<p>Next, to ensure that inbound traffic on ports 80 and 443 into to the WAN ip, I just installed nginx and started it up.</p>
<div class="code"><pre class="code literal-block">pkg install -y nginx
service nginx onestart
</pre></div>

<p>Done!</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/bridge/" rel="tag">bridge</a></li>
            <li><a class="tag p-category" href="../../categories/freebsd/" rel="tag">freebsd</a></li>
            <li><a class="tag p-category" href="../../categories/jails/" rel="tag">jails</a></li>
            <li><a class="tag p-category" href="../../categories/pf/" rel="tag">pf</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../linux-phonehome/" rel="prev" title="linux phonehome">Previous post</a>
            </li>
            <li class="next">
                <a href="../connecting-to-a-drac-5-from-modern-linux/" rel="next" title="Connecting to a drac 5 from modern linux">Next post</a>
            </li>
        </ul></nav></aside></article></main><footer id="footer"><p>©2025 Steven Douglas</p>
            
        </footer>
</div>
    
    

    
    
    
</body>
</html>
